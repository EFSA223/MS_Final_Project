<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />

    <title>MS-Final Assignment @2020</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta charset="utf-8">

    <link href="https://api.mapbox.com/mapbox.js/v3.2.0/mapbox.css" rel="stylesheet" />
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">  <!-- symbols in sidebar -->
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA==" crossorigin="" />
    <link rel="stylesheet" href="../libs/css/leaflet-sidebar.css" />
    <!-- Marker Clusters -->
    <link rel="stylesheet" href="../libs/MarkerCluster.Default.css">
    <link rel="stylesheet" href="../libs/MarkerCluster.css">
    <!-- Sidebar V-2 -->
    <link rel="stylesheet" href="libs/css/leaflet-sidebar.css" />

    <style>
      body {
        /* font-family: sans-serif; */
        margin: 0;
        padding: 0;
      }

      html, body, #map {
        position: absolute;
        width: 100%;
        top: 0;
        bottom: 0;
      }

      .filter {
        position: absolute;
        right: 48px;
        width: 260px;
        font-size: 1.3em;
      }

    </style>
  </head>

  <body>
    <!-- <div id="map"></div> -->

    <div id="sidebar" class="sidebar collapsed">
        <!-- Nav tabs -->
        <div class="sidebar-tabs">
            <ul role="tablist">
                <li><a href="#home" role="tab"><i class="fa fa-bars"></i></a></li>
                <li><a href="#profile" role="tab"><i class="fa fa-user"></i></a></li>
                <li class="disabled"><a href="#messages" role="tab"><i class="fa fa-envelope"></i></a></li>
                <li><a href="https://github.com/Turbo87/sidebar-v2" role="tab" target="_blank"><i class="fa fa-github"></i></a></li>
            </ul>

            <ul role="tablist">
                <li><a href="#settings" role="tab"><i class="fa fa-gear"></i></a></li>
            </ul>
        </div>

        <!-- Tab panes -->
        <div class="sidebar-content">
            <div class="sidebar-pane" id="home">
                <h1 class="sidebar-header">
                    Road Crashes Utrecht, The Netherland
                    <span class="sidebar-close"><i class="fa fa-caret-left"></i></span>
                </h1>

                <p>A responsive sidebar for mapping libraries like <a href="http://leafletjs.com/">Leaflet</a> or <a href="http://openlayers.org/">OpenLayers</a>.</p>

                <p class="lorem">Lorem ipsum dolor sit amet, consetetur sadipscing elitr,
                   sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat,
                   sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren,
                   no sea takimata sanctus est Lorem ipsum dolor sit amet. Lorem ipsum dolor sit amet, consetetur sadipscing elitr,
                   sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat,
                   sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren,
                   no sea takimata sanctus est Lorem ipsum dolor sit amet.</p>

                <p class="lorem">Lorem ipsum dolor sit amet, consetetur sadipscing elitr,
                  sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat,
                  sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren,
                  no sea takimata sanctus est Lorem ipsum dolor sit amet. Lorem ipsum dolor sit amet, consetetur sadipscing elitr,
                  sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat,
                  sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren,
                  no sea takimata sanctus est Lorem ipsum dolor sit amet.</p>

            </div>

            <div class="sidebar-pane" id="profile">
                <h1 class="sidebar-header">Profile<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
            </div>

            <div class="sidebar-pane" id="messages">
                <h1 class="sidebar-header">Messages<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
            </div>

            <div class="sidebar-pane" id="settings">
                <h1 class="sidebar-header">Settings<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
            </div>
        </div>
    </div>

    <div id="map" class="sidebar-map"></div>

    <!-- <select id="d3-dropdown">
        <option value="first">First</option>
        <option value="second">Second</option>
        <option value="third">Third</option>
        <option value="forth">Forth</option>
      </select>
      
      <p id="selected-dropdown"></p> -->
    
    <!--JQuery-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <!--MapBox-->
    <script src='https://api.mapbox.com/mapbox.js/v3.2.0/mapbox.js'></script>
    <!--D3-->
    <script src="https://d3js.org/d3-fetch.v1.min.js"></script>
    <!--Sidebar-->
    <script src="../libs/js/leaflet-sidebar.js"></script>


    <!-- <script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js" integrity="sha512-QVftwZFqvtRNi0ZyCtsznlKSWOStnDORoefr1enyq5mVL4tmKB3S/EnC3rRJcxCPavG10IcrVGSmPh6Qw5lwrg==" crossorigin=""></script> -->
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <!-- <script src="https://d3js.org/d3-dsv.v1.min.js"></script> -->
    <!-- <script src="https://d3js.org/d3-fetch.v1.min.js"></script> -->
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <!-- <script src="https://unpkg.com/topojson@3"></script> -->
    <!-- <script src="https://npmcdn.com/@turf/turf/turf.min.js"></script> -->
    <!-- <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script> -->
    
    
    <script>

      // d3.select("#selected-dropdown").text("first");

      // d3.select("select")
      //   .on("change",function(d){
      //     var selected = d3.select("#d3-dropdown").node().value;
      //     console.log( selected );
      //     d3.select("#selected-dropdown").text(selected);
      // })

      var iconA = L.icon({
            iconUrl: 'icons/Stop1NormalRed.png'
             , iconSize: [10, 10], // size of the icon 
             //iconAnchor: [20, 20], // point of the icon which will correspond to marker's location 
             popupAnchor: [0, 0]
                // point from which the popup should open relative to the iconAnchor 
        });
        var iconB = L.icon({
            iconUrl: 'icons/Stop1NormalBlue.png'
             , iconSize: [10, 10], // size of the icon 
             //iconAnchor: [20, 20], // point of the icon which will correspond to marker's location 
             popupAnchor: [0, 0]
                // point from which the popup should open relative to the iconAnchor 
        });
        var iconC = L.icon({
            iconUrl: 'icons/Stop1Normal.png'
             , iconSize: [10, 10], // size of the icon 
             //iconAnchor: [20, 20], // point of the icon which will correspond to marker's location 
             popupAnchor: [0, 0]
                // point from which the popup should open relative to the iconAnchor 
        });

      var map = L.map("map", {
        zoomSnap: 0.1,
        // center: [52.12, 4.90],
        // center: [52.119582, 5.19955], //Nederland
        center: [52.119, 5.197], //Utrecht
        zoom: 11
      }); 

      // mapbox access token
      var accessToken = "pk.eyJ1IjoiZWYtc2FtYm8iLCJhIjoiY2syczR4eWtuMDZjcDNjbzM0eGhoaHB0MyJ9.3-yTH_cLheshPQa_n8zHgw";

      // add mapbox tile layers using access token
      L.tileLayer(
        "https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=" + accessToken,
        {
          attribution:
            'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
          maxZoom: 20,
          id: "mapbox.light",
          accessToken: accessToken
        }
      ).addTo(map);


        // load Road Crashes geojson file and call function to add data to map
        $.getJSON("data/clean/gemeenten_utrecht_15.geojson", function (dataPoly) {
          L.geoJson(dataPoly, {
            style: function(feature) {
            return {
                color: '#1f78b4',
                weight: 0.9,
                fillOpacity: 0.2,
                fillColor: '#dddddd'
              };
            },
            onEachFeature : function(feature, layer) {
            var countyName = feature.properties.NAME_2;
            //var rentPrice = feature.properties.RENT;
            //var rentTip = "<b>" + countyName + "</b><br> average rent: $" + rentPrice;
            layer.bindTooltip(countyName);
            layer.on({
                click: zoomToFeature
            });
        }
          }).addTo(map);
        });

        // load Road Crashes geojson file and call function to add data to map
        // $.getJSON("data/clean/ned2018_4326.geojson", function (data) {
        $.getJSON("data/clean/verkeersOng_UTR_2016-2018_5.geojson", function (data) {  
            drawMap(data);
        });

        function drawMap(data) {
        // create a Leaflet GeoJSON object using the data and add it to the map
          var geojsonMarkerOptions = {
            radius: 2,
            fillColor: "#142850",
            color: "#cccccc",
            weight: 1,
            opacity: 1,
            fillOpacity: 0.8
          };

console.log(data);
          dataCluster(data);
          //addFilter(yearData, data);

//===== Filter per Year!!!
          var schade = L.geoJson(data, {
            pointToLayer: function(feature,latlng){
              return L.circleMarker(latlng, geojsonMarkerOptions);
            },
            filter: function(feature) {
              if(feature.properties.JAAR_VKL==2016) {
                return feature;
              }
              //console.log(feature);
            },
            style: function(feature) {
              return {
                radius: 2,
                color: '#1f78b4',
                fillColor: '#009933',
                //radius: getRadius(feature.properties.fuel_source.Hydro)
              }
            }
          })//.addTo(map);

          var schade = L.geoJson(data, {
            pointToLayer: function(feature,latlng){
              return L.circleMarker(latlng, geojsonMarkerOptions);
            },
            filter: function(feature) {
              if(feature.properties.JAAR_VKL==2017) {
                return feature;
              }
              //console.log(feature);
            },
            style: function(feature) {
              return {
                radius: 2,
                color: '#1f78b4',
                fillColor: '#3333ff',
                //radius: getRadius(feature.properties.fuel_source.Hydro)
              }
            }
          })//.addTo(map);

          var schade = L.geoJson(data, {
            pointToLayer: function(feature,latlng){
              return L.circleMarker(latlng, geojsonMarkerOptions);
            },
            filter: function(feature) {
              if(feature.properties.JAAR_VKL==2018) {
                return feature;
              }
              //console.log(feature);
            },
            style: function(feature) {
              return {
                radius: 2,
                color: '#1f78b4',
                fillColor: '#ff0000',
                //radius: getRadius(feature.properties.fuel_source.Hydro)
              }
            }
          })//.addTo(map);
//=====
//===== Filter pet type accident

          var schade = L.geoJson(data, {
            pointToLayer: function(feature,latlng){
              return L.circleMarker(latlng, geojsonMarkerOptions);
            },
            filter: function(feature) {
              if(feature.properties.AP3_CODE=="UMS") {
                return feature;
              }
              //console.log(feature);
            },
            style: function(feature) {
              return {
                radius: 2,
                color: '#1f78b4',
                fillColor: '#009933',
                //radius: getRadius(feature.properties.fuel_source.Hydro)
              }
            }
          })//.addTo(map);

          var letsels = L.geoJson(data, {
            pointToLayer: function(feature2,latlng){
              return L.circleMarker(latlng, geojsonMarkerOptions);
            },
            filter: function(feature2) {
              if(feature2.properties.AP3_CODE=="LET") {
                return feature2;
              }
              //console.log(feature2);
            },
            style: function(feature2) {
              return {
                radius: 3,
                color: '#1f78b4',
                fillColor: '#3333ff',
                //radius: getRadius(feature.properties.fuel_source.Hydro)
              }
            }
          })//.addTo(map);

          var fatalies = L.geoJson(data, {
            pointToLayer: function(feature3,latlng){
              return L.circleMarker(latlng, geojsonMarkerOptions);
            },
            filter: function(feature3) {
              if(feature3.properties.AP3_CODE=="DOD") {
                return feature3;
              }
              //console.log(feature3);
            },
            style: function(feature3) {
              return {
                radius: 5,
                color: '#1f78b4',
                fillColor: '#ff0000',
                //radius: getRadius(feature.properties.fuel_source.Hydro)
              }
            }
          })//.addTo(map);

          // // console.log(data);
          // console.log(fatalies); 

          // Add sidebar to the map!
          var sidebar = L.control.sidebar('sidebar').addTo(map); 

          // loop through all the crashes
          fatalies.eachLayer(function (layer) {
            // access the name for each
            var popup=
              "<p>"
                     + //"Informatie:"+"<br>"+
                    // "<ul>"+
                          "<li>Year: "+layer.feature.properties.JAAR_VKL+"</li>"+
                          "<li>Provincie: "+layer.feature.properties.PVE_CODE+"</li>"+
                          "<li>Categorie: "+layer.feature.properties.AP3_CODE+"</li>"+
                    // "</ul>"+
              "</p>";

            // bind that name to a tooltip
            layer.bindTooltip(popup);

          });

        };

        function dataCluster(data) {      
          const accident = data;     
            var markers = L.markerClusterGroup();                                 // create new markerClusterGroup    
            accident.features.forEach(function(feature) {                          // loop through all our signals features    
              var coords = feature.geometry.coordinates
              var cat =  feature.properties.AP3_CODE 
              if (cat =="DOD") { 
                  marker = L.marker([coords[1], coords[0]], {
//==
                  icon : iconA
//==
                  });
              }
              else if (cat =="LET") {
                marker = L.marker([coords[1], coords[0]], {
  //==
                    icon : iconB
  //==
                    });
              }
              else {
                marker = L.marker([coords[1], coords[0]], {
  //==
                    icon : iconC
  //==
                    });
              };
              marker.bindTooltip("YEAR: " + feature.properties.JAAR_VKL);         // bind a tooltip to the marker
              markers.addLayer(marker);  
              //console.log(marker); 
              //console.log(accident);
              console.log(cat);                                        // add the marker to the markerClusterGroup
          });
          map.addLayer(markers);                                                // add the markerClusterGroup to the map
        };

        function zoomToFeature(e) {
          map.fitBounds(e.target.getBounds());
        };

        // function addFilter(yearData, data) {
        //   var dropdown = d3.select('#map')
        //     .append('select')  // append a new select element
        //     .attr('class', 'filter')  // add a class name
        //   var uniqueTypes = ["All facilities"];
        //   yearData.forEach(function (facility) {y
        //     if (!uniqueTypes.includes(facility.Industry_Type)) uniqueTypes.push(facility.JAAR_VKL)
        //   })
        //   uniqueTypes.sort();
        //   // ["All facilities", "Chemicals", "Metals", "Minerals", "Other", "Petroleum and Natural Gas Systems", "Power Plants", "Waste"]
        //   console.log(uniqueTypes)
        // }

    </script>
  </body>
</html>